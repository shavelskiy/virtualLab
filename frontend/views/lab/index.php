<script language="javascript" type="text/javascript" src="flot/jquery.js"></script>
<script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="flot/jquery.flot.stack.js"></script>
<script language="javascript" type="text/javascript" src="flot/jquery.flot.selection.js"></script>

<p><noscript><strong style="color: red;">Для отображения данных необходимо включить JavaScript!</strong></noscript></p>
<div id="placeholder" style="width:600px;height:300px;float:left;"></div>
<div style="float:left;">
    <div id="legend"></div>
    <p style="text-align: center;"><a href="#" onclick="switch_show(); return false;">Сменить вид</a></p>
</div>
<div style="clear: both;"></div>
<div id="overview" style="margin-top:20px;width:600px;height:50px"></div>

<script language="javascript" type="text/javascript">
    // выделенная область
    var selection = ["2008/12/01", "2010/12/01"];
    // все данные
    // цвета задавать обязательно, иначе они будут все время меняться при удалении/добавлении рядов
    var all_data = [
        { label: "Данные 1", color: 0, data: [["2006/01/01", 39], ["2006/02/01", 35], ["2006/03/01", 27], ["2006/04/01", 17], ["2006/05/01", 8], ["2006/06/01", 2], ["2006/07/01", 0], ["2006/08/01", 2], ["2006/09/01", 9], ["2006/10/01", 19], ["2006/11/01", 28], ["2006/12/01", 36], ["2007/01/01", 39], ["2007/02/01", 38], ["2007/03/01", 32], ["2007/04/01", 23], ["2007/05/01", 13], ["2007/06/01", 5], ["2007/07/01", 0], ["2007/08/01", 0], ["2007/09/01", 5], ["2007/10/01", 13], ["2007/11/01", 23], ["2007/12/01", 32], ["2008/01/01", 38], ["2008/02/01", 39], ["2008/03/01", 36], ["2008/04/01", 28], ["2008/05/01", 19], ["2008/06/01", 9], ["2008/07/01", 2], ["2008/08/01", 0], ["2008/09/01", 2], ["2008/10/01", 8], ["2008/11/01", 17], ["2008/12/01", 27], ["2009/01/01", 35], ["2009/02/01", 39], ["2009/03/01", 38], ["2009/04/01", 33], ["2009/05/01", 24], ["2009/06/01", 14], ["2009/07/01", 6], ["2009/08/01", 1], ["2009/09/01", 0], ["2009/10/01", 4], ["2009/11/01", 12], ["2009/12/01", 22], ["2010/01/01", 31], ["2010/02/01", 37], ["2010/03/01", 39], ["2010/04/01", 37], ["2010/05/01", 30], ["2010/06/01", 20], ["2010/07/01", 10], ["2010/08/01", 3], ["2010/09/01", 0], ["2010/10/01", 1], ["2010/11/01", 7], ["2010/12/01", 16]]},
        { label: "Данные 2", color: 1, data: [["2006/01/01", 16], ["2006/02/01", 7], ["2006/03/01", 1], ["2006/04/01", 0], ["2006/05/01", 3], ["2006/06/01", 11], ["2006/07/01", 20], ["2006/08/01", 30], ["2006/09/01", 37], ["2006/10/01", 39], ["2006/11/01", 37], ["2006/12/01", 31], ["2007/01/01", 22], ["2007/02/01", 12], ["2007/03/01", 4], ["2007/04/01", 0], ["2007/05/01", 1], ["2007/06/01", 6], ["2007/07/01", 15], ["2007/08/01", 25], ["2007/09/01", 33], ["2007/10/01", 39], ["2007/11/01", 39], ["2007/12/01", 35], ["2008/01/01", 27], ["2008/02/01", 17], ["2008/03/01", 8], ["2008/04/01", 2], ["2008/05/01", 0], ["2008/06/01", 2], ["2008/07/01", 9], ["2008/08/01", 19], ["2008/09/01", 29], ["2008/10/01", 36], ["2008/11/01", 39], ["2008/12/01", 38], ["2009/01/01", 32], ["2009/02/01", 23], ["2009/03/01", 13], ["2009/04/01", 5], ["2009/05/01", 0], ["2009/06/01", 0], ["2009/07/01", 5], ["2009/08/01", 13], ["2009/09/01", 23], ["2009/10/01", 32], ["2009/11/01", 38], ["2009/12/01", 39], ["2010/01/01", 36], ["2010/02/01", 28], ["2010/03/01", 19], ["2010/04/01", 9], ["2010/05/01", 2], ["2010/06/01", 0], ["2010/07/01", 2], ["2010/08/01", 8], ["2010/09/01", 18], ["2010/10/01", 27], ["2010/11/01", 35], ["2010/12/01", 39]]},
        { label: "Данные 3", color: 2, data: [["2006/01/01", 3], ["2006/02/01", 0], ["2006/03/01", 1], ["2006/04/01", 7], ["2006/05/01", 16], ["2006/06/01", 26], ["2006/07/01", 34], ["2006/08/01", 39], ["2006/09/01", 39], ["2006/10/01", 34], ["2006/11/01", 25], ["2006/12/01", 16], ["2007/01/01", 7], ["2007/02/01", 1], ["2007/03/01", 0], ["2007/04/01", 3], ["2007/05/01", 11], ["2007/06/01", 21], ["2007/07/01", 30], ["2007/08/01", 37], ["2007/09/01", 39], ["2007/10/01", 37], ["2007/11/01", 31], ["2007/12/01", 21], ["2008/01/01", 11], ["2008/02/01", 4], ["2008/03/01", 0], ["2008/04/01", 1], ["2008/05/01", 6], ["2008/06/01", 15], ["2008/07/01", 25], ["2008/08/01", 33], ["2008/09/01", 39], ["2008/10/01", 39], ["2008/11/01", 35], ["2008/12/01", 27], ["2009/01/01", 17], ["2009/02/01", 8], ["2009/03/01", 1], ["2009/04/01", 0], ["2009/05/01", 3], ["2009/06/01", 10], ["2009/07/01", 19], ["2009/08/01", 29], ["2009/09/01", 36], ["2009/10/01", 39], ["2009/11/01", 38], ["2009/12/01", 32], ["2010/01/01", 22], ["2010/02/01", 13], ["2010/03/01", 4], ["2010/04/01", 0], ["2010/05/01", 0], ["2010/06/01", 5], ["2010/07/01", 14], ["2010/08/01", 24], ["2010/09/01", 33], ["2010/10/01", 38], ["2010/11/01", 39], ["2010/12/01", 36]]},
        { label: "Данные 4", color: 3, data: [["2006/01/01", 38], ["2006/02/01", 39], ["2006/03/01", 35], ["2006/04/01", 27], ["2006/05/01", 18], ["2006/06/01", 8], ["2006/07/01", 2], ["2006/08/01", 0], ["2006/09/01", 2], ["2006/10/01", 9], ["2006/11/01", 19], ["2006/12/01", 28], ["2007/01/01", 36], ["2007/02/01", 39], ["2007/03/01", 38], ["2007/04/01", 32], ["2007/05/01", 23], ["2007/06/01", 13], ["2007/07/01", 5], ["2007/08/01", 0], ["2007/09/01", 0], ["2007/10/01", 5], ["2007/11/01", 13], ["2007/12/01", 23], ["2008/01/01", 32], ["2008/02/01", 38], ["2008/03/01", 39], ["2008/04/01", 36], ["2008/05/01", 29], ["2008/06/01", 19], ["2008/07/01", 9], ["2008/08/01", 2], ["2008/09/01", 0], ["2008/10/01", 2], ["2008/11/01", 8], ["2008/12/01", 17], ["2009/01/01", 27], ["2009/02/01", 35], ["2009/03/01", 39], ["2009/04/01", 38], ["2009/05/01", 33], ["2009/06/01", 24], ["2009/07/01", 15], ["2009/08/01", 6], ["2009/09/01", 1], ["2009/10/01", 0], ["2009/11/01", 4], ["2009/12/01", 12], ["2010/01/01", 22], ["2010/02/01", 31], ["2010/03/01", 37], ["2010/04/01", 39], ["2010/05/01", 37], ["2010/06/01", 30], ["2010/07/01", 20], ["2010/08/01", 11], ["2010/09/01", 3], ["2010/10/01", 0], ["2010/11/01", 1], ["2010/12/01", 7]]},
        { label: "Данные 5", color: 4, data: [["2006/01/01", 30], ["2006/02/01", 21], ["2006/03/01", 11], ["2006/04/01", 3], ["2006/05/01", 0], ["2006/06/01", 1], ["2006/07/01", 6], ["2006/08/01", 15], ["2006/09/01", 25], ["2006/10/01", 34], ["2006/11/01", 39], ["2006/12/01", 39], ["2007/01/01", 35], ["2007/02/01", 26], ["2007/03/01", 17], ["2007/04/01", 7], ["2007/05/01", 1], ["2007/06/01", 0], ["2007/07/01", 3], ["2007/08/01", 10], ["2007/09/01", 20], ["2007/10/01", 29], ["2007/11/01", 36], ["2007/12/01", 39], ["2008/01/01", 38], ["2008/02/01", 31], ["2008/03/01", 22], ["2008/04/01", 12], ["2008/05/01", 4], ["2008/06/01", 0], ["2008/07/01", 0], ["2008/08/01", 5], ["2008/09/01", 14], ["2008/10/01", 24], ["2008/11/01", 33], ["2008/12/01", 38], ["2009/01/01", 39], ["2009/02/01", 35], ["2009/03/01", 28], ["2009/04/01", 18], ["2009/05/01", 9], ["2009/06/01", 2], ["2009/07/01", 0], ["2009/08/01", 2], ["2009/09/01", 9], ["2009/10/01", 18], ["2009/11/01", 28], ["2009/12/01", 36], ["2010/01/01", 39], ["2010/02/01", 38], ["2010/03/01", 32], ["2010/04/01", 24], ["2010/05/01", 14], ["2010/06/01", 5], ["2010/07/01", 0], ["2010/08/01", 0], ["2010/09/01", 5], ["2010/10/01", 13], ["2010/11/01", 23], ["2010/12/01", 32]]} // IE не понимает запятых на конце :(
    ];

    // какие данные скрываем - заполняем позже
    var hide = [];
    // преобразуем даты в формат, понятный Flot'у
    for(var j = 0; j < all_data.length; ++j) {
        hide.push(false); // не скрываем j-ый ряд. пока что.
        for(var i = 0; i < all_data[j].data.length; ++i)
            all_data[j].data[i][0] = Date.parse(all_data[j].data[i][0]);
    }
    for(var i = 0; i < selection.length; ++i)
        selection[i] = Date.parse(selection[i]);

    var overview; // "обзор" всех данных внизу страницы
    var plot; // график крупным планом
    var show_bars = false; // показывать столбики или линии
    var plot_conf = {
        series: {
            stack: null,
            lines: {
                show: true,
                lineWidth: 2
            }
        },
        xaxis: {
            mode: "time",
            timeformat: "%y/%m/%d",
            min: selection[0],
            max: selection[1]
        },
        legend: {
            container: $("#legend")
        }
    };

    var overview_conf = {
        series: {
            lines: {
                show: true,
                lineWidth: 1
            },
            shadowSize: 0
        },
        xaxis: {
            ticks: []
        },
        yaxis: {
            ticks: []
        },
        selection: {
            mode: "x"
        },
        legend: {
            show: false
        }
    };

    // меняем вид - столбики или линии
    function switch_show() {
        show_bars = !show_bars; // изменяем тип диаграм

        var new_conf = {
            series: {
                stack: show_bars ? true : null,
                lines: { show: !show_bars },
                bars: { show: show_bars }
            }
        };

        // обновляем конфиг
        $.extend(true, plot_conf, new_conf);
        $.extend(true, overview_conf, new_conf);

        // перерисовываем
        redraw();
    }

    // перерисовываем все и вся :)
    function redraw() {
        var data = [];
        for(var j = 0; j < all_data.length; ++j)
            if(!hide[j])
                data.push(all_data[j]);

        plot = $.plot($("#placeholder"), data, plot_conf);
        overview = $.plot($("#overview"), data, overview_conf);

        // легенду рисуем только один раз
        plot_conf.legend.show = false;

        // последний аргумент - чтобы избежать рекурсии
        overview.setSelection({ x1: selection[0], x2: selection[1] }, true);
    }

    // вычисляем ширину колонки в соответствии с новой областью выделения
    function calc_bar_width() {
        // поскольку по оси OX откладывается время,
        // ширина столбцов в гистограмме вычисляется в 1/1000-ых секунды
        // при масштабировании эту величину следует пересчитать
        var r = plot_conf.xaxis;
        // вычисляем, сколько столбцов попало в интервал
        var bars_count = 0;
        for(var i = 0; i < all_data[0].data.length; ++i)
            if(all_data[0].data[i][0] >= r.min &&
                all_data[0].data[i][0] <= r.max)
                bars_count++;

        // изменяем ширину столбцов
        var new_conf = {
            series: {
                bars: { // умножаем на два, чтобы оставалось место между столбцами
                    barWidth: (r.max - r.min)/((bars_count + 1 /* на ноль не делим */) * 2)
                }
            }
        };
        $.extend(true, plot_conf, new_conf);
    }

    // вычисляем ширину столбцов в гистограмме
    calc_bar_width();
    // рисуем графики в первый раз
    redraw();

    // событие - новое выделение на overview
    $("#overview").bind("plotselected", function (event, ranges) {
        var r = ranges.xaxis;
        // сохраняем координаты выделенной области
        selection = [r.from, r.to];

        // перемещаем обзор в новую область
        var new_conf = {
            xaxis: {
                min: r.from,
                max: r.to
            }
        };
        $.extend(true, plot_conf, new_conf);

        calc_bar_width();
        redraw();
    });

    // рисуем чекбоксы в легенде
    var legend = document.getElementById('legend'); // еще IE не умеет заменять innerHTML в table
    var legend_tbl = legend.getElementsByTagName('table')[0];
    var legend_html = '<table style="font-size: smaller; color: rgb(84, 84, 84);"><tbody>';
    for(var i = 0; i < legend_tbl.rows.length; i++) {
        legend_html += '<tr>' +
            '<td><input type="checkbox" onclick="hide['+ i +']=!hide['+ i +'];redraw();" checked="1"></td>'
            + legend_tbl.rows[i].innerHTML
            + '</tr>';
    }
    legend_html += "</tbody></table>";
    legend.innerHTML = legend_html;
</script>